dist: xenial
language: bash
# Instalacao terraform package
before_install:
  - wget https://releases.hashicorp.com/terraform/0.12.25/terraform_0.12.25_linux_amd64.zip
  - unzip terraform_0.12.25_linux_amd64.zip
  - sudo mv terraform /usr/local/bin/
  - rm terraform_0.12.25_linux_amd64.zip
jobs:
  include:
# Passo 1 - Terraform Plan
  - stage: terraform plan deployment
    if: type IN (pull_request)
    script:
    - terraform init -backend-config backend_config/dev.tfvars
    - terraform plan
# Passo 2 - Terraform Apply
  - stage: terraform plan deployment 
    script:
    - terraform init
    - terraform plan
    - terraform validate
    - terraform apply -auto-approve
# Auto Merge caso status de pipeline seja success TDLR
    after_success: ./setup-pipeline-steps/merge.sh $USERNAME $PASSWORD